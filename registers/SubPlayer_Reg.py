import asyncio

import discord
from discord.ext import commands

from db.users import Users
from views.System.Register import RegisterButton


def count_access():
    amount = Users().user_count()
    total  = (52 - int(amount))
    return total


class SubPlayer_Register_Access(discord.ui.View):
    def __init__(self, bot):
        super(SubPlayer_Register_Access, self).__init__(timeout=None)
        self.bot = bot
        self.cooldown = commands.CooldownMapping.from_cooldown(1, 30, commands.BucketType.member)
    @discord.ui.button(label="‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å SubPlayer", style=discord.ButtonStyle.secondary, emoji="üìù", custom_id='reg_access')
    async def reg_access(self, button, interaction: discord.Interaction):
        interaction.message.author = interaction.user
        bucket = self.cooldown.get_bucket(interaction.message)
        retry = bucket.update_rate_limit()
        if retry:
            return await interaction.response.send_message(
                f'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏≠‡∏µ‡∏Å {round(retry,30)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', ephmeral=True
            )
        if Users().check(interaction.user.id) == 1:
            await interaction.response.send_message(f"{interaction.user.mention} ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß", ephemeral=True)
        if count_access() == 0:
            return await interaction.response.send_message(f"{interaction.user.mention} ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß",ephemeral=True)

        button.disabled = False
        member = interaction.user
        guild = interaction.guild
        cat_name = "USER PROFILES"
        room_name = "üìù-‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô-id-{}".format(member.discriminator)
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(
                view_channel=False,
                read_messages=False
            )
        }
        try:
            category = discord.utils.get(guild.categories, name=cat_name)
            if category:
                pass
            else:
                await guild.create_category(name=cat_name, overwrites=overwrites)
        except Exception as e:
            return await interaction.response.edit_message(content=e, view=None)
        else:
            try:
                cate = discord.utils.get(guild.categories, name=cat_name)
                if cate:
                    channel = discord.utils.get(guild.channels, name=room_name)
                    if channel:
                        await channel.delete()
            except Exception as e:
                return await interaction.response.edit_message(content=e, view=None)
            else:
                overwrites = {
                    guild.default_role:discord.PermissionOverwrite(
                      view_channel=True
                    ),
                    member: discord.PermissionOverwrite(
                        view_channel=True,
                        read_messages=True,
                        send_messages=True,
                        read_message_history=True
                    )
                }
                register_channel = await guild.create_text_channel(name=room_name, category=cate, overwrites=overwrites)
                await register_channel.edit(sync_permissions=True,)
                await register_channel.set_permissions(member, view_channel=True, send_messages=True, read_message_history=True, read_messages=True)
                await interaction.response.edit_message(content=f"‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á {register_channel.mention} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô", view=None, embed=None)
                return await register_channel.send(file=discord.File('./img/concept/steam.png'), view=RegisterButton(self.bot))

    @discord.ui.button(label="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü", style=discord.ButtonStyle.secondary, emoji="‚ö†", custom_id="cancle_to_reg")
    async def cancle_to_reg(self, button, interaction:discord.Interaction):
        button.disabled=False
        await interaction.response.edit_message(content="‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà", view=LeaveServer(), embed=None)

class LeaveServer(discord.ui.View):
    def __init__(self):
        super(LeaveServer, self).__init__(timeout=None)

    @discord.ui.button(label="Yes", style=discord.ButtonStyle.danger, emoji="‚ùï", custom_id="player_leave")
    async def player_leave(self, button, interaction:discord.Interaction):
        guild = interaction.guild
        button.disabled=False
        await interaction.response.edit_message(f"{interaction.user.mention} ‡∏≠‡∏µ‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤")
        await asyncio.sleep(10)
        await guild.kick(interaction.user)
    @discord.ui.button(label="No", style=discord.ButtonStyle.secondary, emoji="üö´", custom_id="player_leave_cancle")
    async def player_leave_cancle(self, button, interaction:discord.Interaction):
        button.disabled=False
        await interaction.response.edit_message(content=f"{interaction.user.mention} ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", view=None)
